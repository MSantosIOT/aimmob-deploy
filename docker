# Usa a imagem base do Debian mais recente
FROM debian:latest

# Define o diretório de trabalho
WORKDIR /app

# Atualiza os pacotes e instala dependências essenciais
RUN apt update && apt install -y \
    postgresql \
    postgresql-contrib \
    postgresql-client \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    sudo \
    wget \
    unzip \
    gnupg \
    apache2 \
    && apt clean

# Configuração do PostgreSQL
RUN service postgresql start && \
    sudo -u postgres psql -c "CREATE USER aimmob WITH PASSWORD 'aimmob123';" && \
    sudo -u postgres psql -c "CREATE DATABASE aimmobdb OWNER aimmob;" && \
    sudo -u postgres psql -c "ALTER USER aimmob CREATEDB;"

# Instalação do PgAdmin
RUN wget -qO - https://www.pgadmin.org/static/packages_pgadmin_org.pub | apt-key add - && \
    echo "deb https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/debian/ bookworm main" > /etc/apt/sources.list.d/pgadmin4.list && \
    apt update && \
    apt install -y pgadmin4-web && \
    /usr/pgadmin4/bin/setup-web.sh --yes

# Instalação do Langflow
RUN pip3 install langflow

# Expor as portas necessárias
EXPOSE 5432 15432 7860

# Script de inicialização para rodar os serviços no mesmo container
CMD service postgresql start && \
    service apache2 start && \
    langflow run --host 0.0.0.0 --port 7860